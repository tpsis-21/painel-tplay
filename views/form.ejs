<%- include('layout_header', { title: app ? 'Editar App' : 'Novo App' }) %>

<form action="/save" method="POST" enctype="multipart/form-data" class="space-y-8">
    <% if (app) { %>
        <input type="hidden" name="original_slug" value="<%= app.slug %>">
        <input type="hidden" name="slug" value="<%= app.slug %>">
    <% } %>

    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold"><%= app ? 'Editar Aplicativo' : 'Criar Novo App' %></h1>
            <p class="text-muted-foreground">Preencha os campos para configurar a página do seu app.</p>
        </div>
        <div class="flex items-center space-x-2">
            <button type="button" onclick="window.location.href='/painel'" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-4">
                Cancelar
            </button>
            <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background bg-primary text-primary-foreground hover:bg-primary/90 h-9 px-4">
                <i class="fas fa-save mr-2"></i>
                Salvar
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="md:col-span-2 space-y-6">
            <!-- Card de Identidade -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <h3 class="font-semibold tracking-tight">Identidade do App</h3>
                    <p class="text-sm text-muted-foreground">Nome, logo e arquivo principal.</p>
                </div>
                <div class="p-6 pt-0 space-y-4">
                    <div>
                        <label class="text-sm font-medium">Nome do App</label>
                        <input type="text" name="name" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 mt-1" value="<%= app ? app.name : '' %>" required placeholder="Ex: Meu App Incrível">
                    </div>
                    <div>
                        <label class="text-sm font-medium">Descrição breve (aparece na hero e SEO)</label>
                        <textarea name="description" rows="3" class="w-full rounded-md border border-input bg-background px-3 py-2 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"><%= app ? (app.description || '') : '' %></textarea>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm font-medium">Logo (URL ou Upload)</label>
                            <input type="url" name="logo_url" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 mt-1" placeholder="https://..." value="<%= (app && app.logo && !app.logo.startsWith('/uploads/')) ? app.logo : '' %>">
                            <input type="file" name="logo_file" class="mt-2 block w-full text-sm text-muted-foreground file:mr-4 file:rounded-md file:border file:border-input file:bg-background file:px-3 file:py-2 file:text-sm file:font-medium hover:file:bg-accent file:cursor-pointer" accept="image/*">
                            <input type="hidden" name="logo" value="<%= app ? app.logo : '' %>">
                        </div>
                        <div>
                            <label class="text-sm font-medium">Arquivo APK (URL ou Upload)</label>
                            <input type="url" name="download_url" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 mt-1" placeholder="https://..." value="<%= (app && app.downloadUrl && !app.downloadUrl.startsWith('/uploads/')) ? app.downloadUrl : '' %>">
                            <input type="file" name="download_file" class="mt-2 block w-full text-sm text-muted-foreground file:mr-4 file:rounded-md file:border file:border-input file:bg-background file:px-3 file:py-2 file:text-sm file:font-medium hover:file:bg-accent file:cursor-pointer" accept=".apk">
                            <input type="hidden" name="downloadUrl" value="<%= app ? app.downloadUrl : '' %>">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card de Tutoriais -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6 flex justify-between items-center">
                    <div>
                        <h3 class="font-semibold tracking-tight">Tutoriais de Uso</h3>
                        <p class="text-sm text-muted-foreground">Vídeos explicando como usar o app.</p>
                    </div>
                    <button type="button" onclick="window.addTutorial()" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background border border-input bg-background hover:bg-accent hover:text-accent-foreground h-8 px-3"><i class="fas fa-plus mr-2"></i>Adicionar</button>
                </div>
                <div class="p-6 pt-0">
                    <div id="tutorials-container" class="space-y-4">
                        <% if (app && app.tutorials) { app.tutorials.forEach(tut => { %>
                            <div class="relative grid grid-cols-1 sm:grid-cols-5 gap-3 items-start bg-background/50 p-3 rounded-md border">
                                <div class="sm:col-span-2">
                                    <label class="text-xs font-medium text-muted-foreground">Título</label>
                                    <input type="text" name="tutorial_titles" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 mt-1" placeholder="Como instalar" value="<%= tut.title %>">
                                </div>
                                <div class="sm:col-span-3">
                                    <label class="text-xs font-medium text-muted-foreground">Vídeo (URL ou Upload)</label>
                                    <input type="url" name="tutorial_urls" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 mt-1" placeholder="https://..." value="<%= (tut.url && !tut.url.startsWith('/uploads/')) ? tut.url : '' %>">
                                    <input type="file" name="video_tutorials" class="mt-2 block w-full text-sm text-muted-foreground file:mr-4 file:rounded-md file:border file:border-input file:bg-background file:px-3 file:py-2 file:text-sm file:font-medium hover:file:bg-accent file:cursor-pointer" accept="video/*">
                                </div>
                                <button type="button" onclick="this.closest('.relative').remove()" class="absolute -top-2 -right-2 inline-flex items-center justify-center rounded-full text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background border border-input bg-background hover:bg-accent hover:text-accent-foreground text-muted-foreground hover:text-destructive hover:border-destructive w-6 h-6"><i class="fas fa-times text-xs"></i></button>
                            </div>
                        <% }); } %>
                    </div>
                </div>
            </div>

            <!-- Card de Imagens da Interface -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <h3 class="font-semibold tracking-tight">Imagens da Interface</h3>
                    <p class="text-sm text-muted-foreground">Mostre como é o seu aplicativo por dentro.</p>
                </div>
                <div class="p-6 pt-0">
                    <input type="file" id="interface-images-upload" name="interface_images" class="hidden" accept="image/*" multiple>
                    <label for="interface-images-upload" class="mt-2 flex justify-center rounded-lg border border-dashed border-input px-6 py-10 cursor-pointer hover:border-primary">
                        <div class="text-center">
                            <i class="fas fa-photo-video text-4xl text-muted-foreground"></i>
                            <div class="mt-4 flex text-sm leading-6 text-muted-foreground">
                                <p class="font-semibold text-primary">Clique para enviar</p>
                                <p class="pl-1">ou arraste e solte</p>
                            </div>
                            <p class="text-xs leading-5 text-muted-foreground">PNG, JPG, GIF até 10MB</p>
                        </div>
                    </label>
                    <div id="interface-images-previews" class="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        <% if (app && app.interface_images) { app.interface_images.forEach(img => { %>
                            <div class="relative group existing-image" data-image-url="<%= img %>">
                                <img src="<%= img %>" class="aspect-video w-full rounded-md object-cover">
                                <div class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                    <button type="button" onclick="window.removeImage(this, '<%= img %>', '<%= img.split('/').pop() %>')" class="inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background border border-input bg-background hover:bg-accent hover:text-accent-foreground text-white hover:text-destructive"><i class="fas fa-trash"></i></button>
                                </div>
                                <input type="hidden" name="existing_interface_images" value="<%= img %>">
                            </div>
                        <% }); } %>
                    </div>
                    <div id="deleted-images-container"></div>
                </div>
            </div>
        </div>

        <div class="md:col-span-1 space-y-6">
            <!-- Card de Status -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <h3 class="font-semibold tracking-tight">Status</h3>
                </div>
                <div class="p-6 pt-0 space-y-4">
                    <div class="flex items-center justify-between">
                        <label class="text-sm font-medium">Visível na Loja</label>
                        <select name="visibleOnHome" class="flex h-9 w-auto rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50">
                            <option value="true" <%= (app && app.visibleOnHome) ? 'selected' : '' %>>Sim</option>
                            <option value="false" <%= (app && !app.visibleOnHome) ? 'selected' : '' %>>Não</option>
                        </select>
                    </div>
                    <% if (app) { %>
                        <div class="text-xs text-muted-foreground space-y-1">
                            <p><strong>Slug:</strong> /<%= app.slug %></p>
                            <p><strong>Criado:</strong> <%= new Date(app.createdAt).toLocaleDateString('pt-BR') %></p>
                            <p><strong>Atualizado:</strong> <%= new Date(app.updatedAt).toLocaleDateString('pt-BR') %></p>
                        </div>
                    <% } %>
                </div>
            </div>
            
            <!-- Card de Códigos -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <h3 class="font-semibold tracking-tight">Códigos de Instalação</h3>
                    <p class="text-sm text-muted-foreground">Para apps como Downloader e NTDown.</p>
                </div>
                <div class="p-6 pt-0 space-y-4">
                    <div>
                        <label class="text-sm font-medium">Código Downloader (Fire TV)</label>
                        <input type="text" name="firestickCode" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 mt-1" value="<%= app ? app.firestickCode : '' %>" placeholder="Ex: 12345">
                    </div>
                    <div>
                        <label class="text-sm font-medium">Código NTDown (TV Box / Receptores / Projetores)</label>
                        <input type="text" name="ntdownCode" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 mt-1" value="<%= app ? (app.ntdownCode || app.tvboxCode) : '' %>" placeholder="Ex: 67890">
                    </div>
                </div>
            </div>
            
            <!-- Card de Dispositivos Compatíveis -->
            <div class="rounded-lg border bg-card text-card-foreground shadow-sm">
                <div class="p-6">
                    <h3 class="font-semibold tracking-tight">Dispositivos Compatíveis</h3>
                    <p class="text-sm text-muted-foreground">Selecione onde este app é suportado.</p>
                </div>
                <div class="p-6 pt-0 space-y-3">
                    <% const devs = app && app.compatibleDevices ? app.compatibleDevices : ['android','androidtv','firestick','tvbox']; %>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="devices" value="android" <%= devs.includes('android') ? 'checked' : '' %>>
                        <span>Celular Android</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="devices" value="androidtv" <%= devs.includes('androidtv') ? 'checked' : '' %>>
                        <span>Android TV / Mi Stick</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="devices" value="firestick" <%= devs.includes('firestick') ? 'checked' : '' %>>
                        <span>Fire Stick</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" name="devices" value="tvbox" <%= devs.includes('tvbox') ? 'checked' : '' %>>
                        <span>TV Box / Receptores / Projetores</span>
                    </label>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Lógica para adicionar tutoriais
    function addTutorial() {
        const container = document.getElementById('tutorials-container');
        const newTutorial = document.createElement('div');
        newTutorial.className = 'relative grid grid-cols-1 sm:grid-cols-5 gap-3 items-start bg-background/50 p-3 rounded-md border';
        newTutorial.innerHTML = `
            <div class="sm:col-span-2">
                <label class="text-xs font-medium text-muted-foreground">Título</label>
                <input type="text" name="tutorial_titles" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 mt-1" placeholder="Como instalar">
            </div>
            <div class="sm:col-span-3">
                <label class="text-xs font-medium text-muted-foreground">Vídeo (URL ou Upload)</label>
                <input type="url" name="tutorial_urls" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-1 text-sm shadow-sm transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50 mt-1" placeholder="https://...">
                <input type="file" name="video_tutorials" class="mt-2 block w-full text-sm text-muted-foreground file:mr-4 file:rounded-md file:border file:border-input file:bg-background file:px-3 file:py-2 file:text-sm file:font-medium hover:file:bg-accent file:cursor-pointer" accept="video/*">
            </div>
            <button type="button" onclick="this.closest('.relative').remove()" class="absolute -top-2 -right-2 inline-flex items-center justify-center rounded-full text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:opacity-50 disabled:pointer-events-none ring-offset-background border border-input bg-background hover:bg-accent hover:text-accent-foreground text-muted-foreground hover:text-destructive hover:border-destructive w-6 h-6"><i class="fas fa-times text-xs"></i></button>
        `;
        container.appendChild(newTutorial);
    }
    window.addTutorial = addTutorial;

    // Lógica para upload e preview de imagens da interface
    const uploadInput = document.getElementById('interface-images-upload');
    const previewsContainer = document.getElementById('interface-images-previews');
    
    if (uploadInput) {
        uploadInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length === 0) return;
            
            let loadedCount = 0;
            const totalFiles = files.length;
            
            // Mostrar notificação de início do upload
            showToast(`Iniciando upload de ${totalFiles} imagem(s)...`, 'info');
            
            for (const file of files) {
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative group new-image';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="aspect-video w-full rounded-md object-cover">
                        <div class="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100">
                            <button type="button" onclick="this.closest('.relative').remove()" class="text-white"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    previewsContainer.appendChild(div);
                    
                    loadedCount++;
                    
                    // Mostrar progresso ou conclusão
                    if (loadedCount === totalFiles) {
                        showToast(`${totalFiles} imagem(s) carregada(s) com sucesso!`, 'success');
                    }
                };
                
                reader.onerror = () => {
                    showToast(`Erro ao carregar imagem: ${file.name}`, 'error');
                };
                
                reader.readAsDataURL(file);
            }
        });
    }

    // Lógica para remover imagens existentes
    function removeImage(button, imageUrl, fileName) {
        const imageDiv = button.closest('.existing-image');
        if (imageDiv) {
            imageDiv.style.display = 'none'; // Esconde a imagem
            const deletedContainer = document.getElementById('deleted-images-container');
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'deleted_interface_images';
            
            // Sanitiza o nome do arquivo para evitar problemas com aspas
            const safeFileName = fileName.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            hiddenInput.value = safeFileName;
            
            deletedContainer.appendChild(hiddenInput);
        }
    }
    window.removeImage = removeImage;
});
</script>

<%- include('layout_footer') %>
